<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Matte Meteo</title>
  <link rel="icon" href="icon.ico">
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #4e54c8, #8f94fb);
      color: #fff;
      margin: 0;
      padding: 1rem;
      max-width: 500px;

      margin: auto;
    }
    h1 {
      text-align: center;
      margin: 1rem 0;
      font-size: 2rem;
      text-shadow: 0 2px 6px rgba(0,0,0,.3);
    }
    form {
      display: flex;
      margin-bottom: 1rem;
      background: rgba(255,255,255,.2);
      border-radius: 10px;
      overflow: hidden;
    }
    input, button {
      border: none;
      padding: .7rem 1rem;
      font-size: 1rem;
    }
    input {
      flex: 1;
      background: transparent;
      color: white;
    }
    input::placeholder { color: #ddd; }
    button {
      background: #6c63ff;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    #result .day {
      background: rgba(255,255,255,.15);
      border-radius: 10px;
      padding: .8rem;
      margin-bottom: .6rem;
      cursor: pointer;
    }
    .day .date { font-weight: bold; font-size: 1.1rem; }
    .day .extra { font-size: .9rem; opacity: .8; }
    .hourly {
      display: none; /* ore nascoste di default */
      margin-top: .5rem;
      overflow-x: auto;
      flex-wrap: nowrap;
      gap: .4rem;
    }
    .hour-block {
      background: rgba(255,255,255,.25);
      border-radius: 6px;
      padding: .4rem;
      text-align: center;
      font-size: .7rem;
      min-width: 55px;
    }
    .fav-star { cursor: pointer; font-size: 1.4rem; margin-left: .5rem; }
    footer {
      text-align: center;
      margin-top: 2rem;
      font-size: .8rem;
      opacity: .8;
    }
    select {
      margin-bottom: 1rem;
      padding: .4rem;
      border-radius: 6px;
    }

    /* 📱 Ottimizzazione per telefoni */
    @media (max-width: 480px) {
      body { padding: .5rem; }
      h1 { font-size: 1.6rem; }
      input, button { font-size: .9rem; padding: .6rem; }
      .day .date { font-size: 1rem; }
      .hour-block { font-size: .65rem; min-width: 50px; }
    }
  </style>
</head>
<body>
  <h1>Matte Meteo</h1>

  <select id="favSelect">
    <option value="">⭐ Preferiti</option>
  </select>

  <form id="searchForm">
    <input id="cityInput" type="text" placeholder="Scrivi una città..." required>
    <button>Cerca</button>
  </form>

  <div id="result"></div>

  <footer>
    Alimentato da Open-Meteo & OpenStreetMap<br>
    © Matteo Abate 2025
  </footer>

<script>
const weatherIcons = {
  0:"☀️",1:"🌤️",2:"⛅",3:"☁️",45:"🌫️",48:"🌫️",
  51:"🌦️",53:"🌧️",55:"🌧️",61:"🌧️",63:"🌧️",65:"🌧️",
  71:"❄️",73:"❄️",75:"❄️",77:"❄️",
  80:"🌧️",81:"🌧️",82:"🌧️",
  95:"⛈️",96:"⛈️",99:"⛈️"
};

const form = document.getElementById("searchForm");
const cityInput = document.getElementById("cityInput");
const resultDiv = document.getElementById("result");
const favSelect = document.getElementById("favSelect");

function loadFavorites() {
  const favs = JSON.parse(localStorage.getItem("favs")||"[]");
  favSelect.innerHTML = `<option value="">⭐ Preferiti</option>`;
  favs.forEach(c => {
    favSelect.innerHTML += `<option>${c}</option>`;
  });
}
loadFavorites();

favSelect.addEventListener("change", () => {
  if (favSelect.value) {
    cityInput.value = favSelect.value;
    form.dispatchEvent(new Event("submit"));
  }
});

form.addEventListener("submit", async e => {
  e.preventDefault();
  const city = cityInput.value.trim();
  if (!city) return;
  resultDiv.innerHTML = "⏳ Caricamento...";

  try {
    const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
    const g = await geo.json();
    if (!g.length) throw new Error("Città non trovata");
    const { lat, lon, display_name } = g[0];

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      "&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,windspeed_10m_max" +
      "&hourly=temperature_2m,weathercode,precipitation,windspeed_10m,uv_index" +
      "&current_weather=true&timezone=Europe/Rome";
    const meteo = await fetch(url).then(r=>r.json());

    if (!meteo.daily) throw new Error("Nessun dato meteo");

    let html = `<h2>${display_name}<span class="fav-star" id="favStar">☆</span></h2>`;

    meteo.daily.time.forEach((d,i) => {
      const date = new Date(d).toLocaleDateString("it-IT",{weekday:"long",day:"2-digit",month:"2-digit"});
      const icon = weatherIcons[meteo.daily.weathercode[i]]||"❓";

      let hourlyHTML = "";
      for (let h=0;h<24;h++) {
        const idx = meteo.hourly.time.findIndex(t => t === `${d}T${String(h).padStart(2,"0")}:00`);
        if (idx>-1) {
          hourlyHTML += `
            <div class="hour-block">
              <div>${String(h).padStart(2,"0")}:00</div>
              <div>${weatherIcons[meteo.hourly.weathercode[idx]]||"❓"}</div>
              <div>${meteo.hourly.temperature_2m[idx]}°</div>
            </div>`;
        }
      }

      html += `
      <div class="day">
        <div class="date">${icon} ${date}</div>
        <div>🌡️ Max ${meteo.daily.temperature_2m_max[i]}° / Min ${meteo.daily.temperature_2m_min[i]}°</div>
        <div class="extra">🌧️ ${meteo.daily.precipitation_sum[i]} mm | 💨 ${meteo.daily.windspeed_10m_max[i]} km/h</div>
        <div class="hourly">${hourlyHTML}</div>
      </div>`;
    });

    resultDiv.innerHTML = html;

    document.querySelectorAll(".day").forEach(d=>{
      d.addEventListener("click",()=>{
        const h = d.querySelector(".hourly");
        h.style.display = (h.style.display==="flex")?"none":"flex"; // toggle visibilità ore
      });
    });

    const favStar = document.getElementById("favStar");
    const favs = JSON.parse(localStorage.getItem("favs")||"[]");
    if (favs.includes(city)) favStar.textContent="⭐";

    favStar.onclick = () => {
      let favs = JSON.parse(localStorage.getItem("favs")||"[]");
      if (favs.includes(city)) {
        favs = favs.filter(c=>c!==city);
        favStar.textContent="☆";
      } else {
        favs.push(city);
        favStar.textContent="⭐";
      }
      localStorage.setItem("favs",JSON.stringify(favs));
      loadFavorites();
    };

  } catch(err) {
    resultDiv.innerHTML = `<p style="color:yellow">Errore: ${err.message}</p>`;
  }
});
</script>
</body>
</html>

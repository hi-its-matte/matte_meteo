<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Matte Meteo</title>
<link rel="icon" href="icon.ico">
<style>
  body { font-family: system-ui,sans-serif; background: linear-gradient(135deg,#4e54c8,#8f94fb); color:#fff; margin:0; padding:1rem; max-width:500px; margin:auto; }
  h1{text-align:center;margin:1rem 0;font-size:2rem;text-shadow:0 2px 6px rgba(0,0,0,.3);}
  form{display:flex;margin-bottom:1rem;background:rgba(255,255,255,.2);border-radius:10px;overflow:hidden;}
  input, button{border:none;padding:.7rem 1rem;font-size:1rem;}
  input{flex:1;background:transparent;color:white;}
  input::placeholder{color:#ddd;}
  button{background:#6c63ff;color:white;cursor:pointer;font-weight:bold;}
  #result .day{background:rgba(255,255,255,.15);border-radius:10px;padding:.8rem;margin-bottom:.6rem;cursor:pointer;}
  .day .date{font-weight:bold;font-size:1.1rem;}
  .day .extra{font-size:.9rem;opacity:.8;}
  .hourly{display:none;margin-top:.5rem;overflow-x:auto;flex-wrap:nowrap;gap:.4rem;}
  .hour-block{background:rgba(255,255,255,.25);border-radius:6px;padding:.4rem;text-align:center;font-size:.7rem;min-width:55px;}
  .fav-star{cursor:pointer;font-size:1.4rem;margin-left:.5rem;}
  footer{text-align:center;margin-top:2rem;font-size:.8rem;opacity:.8;}
  select{margin-bottom:1rem;padding:.4rem;border-radius:6px;}
  .loading{opacity:0.6;pointer-events:none;}
  
  /* Popup styles */
  .popup-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;}
  .popup-content{position:relative;max-width:95%;width:700px;border-radius:10px;overflow:hidden;}
  .popup-image{width:100%;display:block;}
  .popup-button{position:absolute;top:60%;right:30%;transform:translateY(-50%);width:130px;height:65px;background:#5ba3c5;border:none;cursor:pointer;border-radius:8px;color:#fff;font-weight:bold;font-size:0.85rem;}
  .popup-button:hover{background:#4a8dad;}
  .popup-close{position:absolute;top:10px;right:10px;background:rgba(255,255,255,0.9);border:none;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:1.2rem;font-weight:bold;color:#333;}
  
  @media(max-width:480px){body{padding:.5rem;}h1{font-size:1.6rem;}input,button{font-size:.9rem;padding:.6rem;}.day .date{font-size:1rem;}.hour-block{font-size:.65rem;min-width:50px;}.popup-button{width:100px;height:40px;}}
</style>
</head>
<body>

<h1>Matte Meteo</h1>

<select id="favSelect">
  <option value="">â­ Preferiti</option>
</select>

<form id="searchForm">
  <input id="cityInput" type="text" placeholder="Scrivi una cittÃ ..." required>
  <button>Cerca</button>
</form>

<div id="result"></div>

<!-- Popup aggiornamento -->
<div class="popup-overlay" id="updatePopup">
  <div class="popup-content">
    <button class="popup-close" onclick="closePopup()">Ã—</button>
    <img src="https://media.mattedev.com/img/mattemeteo/updatebanner.jpg" alt="Tempo di aggiornarsi" class="popup-image">
    <button class="popup-button" onclick="window.open('https://mattedev.com', '_blank')">SCOPRI di piÃ¹</button>
  </div>
</div>

<footer>
  <br>Alimentato da Open-Meteo & OpenStreetMap<br>
  <br>Â© MatteDev, 2025</br>
  <a href="terms.html" style="color:inherit; text-decoration:none;">Termini e Condizioni</a>
  <a href="privacy.html" style="color:inherit; text-decoration:none; margin-left:1rem;">Privacy Policy</a>
  <div style="text-align:center; margin:1rem 0;">
    <a href="https://ko-fi.com/mattedev" target="_blank" rel="noopener">
      <img 
        src="https://storage.ko-fi.com/cdn/brandasset/v2/support_me_on_kofi_badge_blue.png" 
        alt="Supporta su Ko-fi" 
        style="max-width:100px; width:100%; height:auto; cursor:pointer; border:none;"
      >
    </a>
  </div>
</footer>

<script type="module">
const weatherIcons = {
  0:"â˜€ï¸",1:"ğŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ğŸŒ«ï¸",48:"ğŸŒ«ï¸",
  51:"ğŸŒ¦ï¸",53:"ğŸŒ§ï¸",55:"ğŸŒ§ï¸",61:"ğŸŒ§ï¸",63:"ğŸŒ§ï¸",65:"ğŸŒ§ï¸",
  71:"â„ï¸",73:"â„ï¸",75:"â„ï¸",77:"â„ï¸",
  80:"ğŸŒ§ï¸",81:"ğŸŒ§ï¸",82:"ğŸŒ§ï¸",
  95:"â›ˆï¸",96:"â›ˆï¸",99:"â›ˆï¸"
};

const form = document.getElementById("searchForm");
const cityInput = document.getElementById("cityInput");
const resultDiv = document.getElementById("result");
const favSelect = document.getElementById("favSelect");

function getAQIDescription(aqi) {
  if (aqi <= 50) return "Buona ğŸ˜Š";
  if (aqi <= 100) return "Moderata ğŸ˜";
  if (aqi <= 150) return "Sensibili ğŸ˜·";
  if (aqi <= 200) return "Malsana ğŸ˜°";
  if (aqi <= 300) return "Molto Malsana ğŸš¨";
  return "Pericolosa â˜ ï¸";
}

function getUVDescription(uv) {
  if (uv <= 2) return "Basso ğŸŸ¢";
  if (uv <= 5) return "Moderato ğŸŸ¡";
  if (uv <= 7) return "Alto ğŸŸ ";
  if (uv <= 10) return "Molto Alto ğŸ”´";
  return "Estremo ğŸŸ£";
}

// Carica i preferiti
function loadFavorites() {
  const favs = JSON.parse(localStorage.getItem("favs") || "[]");
  favSelect.innerHTML = `<option value="">â­ Preferiti</option>`;
  favs.forEach(c => {
    favSelect.innerHTML += `<option value="${c}">${c}</option>`;
  });
}

// Gestione preferiti dropdown
favSelect.addEventListener("change", () => {
  if(favSelect.value){
    cityInput.value = favSelect.value;
    form.dispatchEvent(new Event("submit"));
    favSelect.value = "";
  }
});

// Inizializzazione
loadFavorites();

// Mostra popup al caricamento (sempre)
window.addEventListener('DOMContentLoaded', () => {
  const popup = document.getElementById('updatePopup');
  popup.style.display = 'flex';
});

// Funzione per chiudere il popup
window.closePopup = function() {
  document.getElementById('updatePopup').style.display = 'none';
};

// Submit form
form.addEventListener("submit", async e => {
  e.preventDefault();
  const city = cityInput.value.trim();
  if(!city) return;
  resultDiv.innerHTML = "â³ Caricamento...";

  try{
    // Geocoding - chiamata diretta a Nominatim
    const geoResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}&limit=1`, {
      headers: {
        'User-Agent': 'MatteMeteo/1.0'
      }
    });
    
    if (!geoResponse.ok) throw new Error("Errore nella ricerca della cittÃ ");
    
    const geoResults = await geoResponse.json();
    
    if(!geoResults.length) throw new Error("CittÃ  non trovata");
    
    const {lat, lon, display_name} = geoResults[0];

    // Meteo principale
    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
      "&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,windspeed_10m_max,uv_index_max"+
      "&hourly=temperature_2m,weathercode,precipitation,windspeed_10m,uv_index"+
      "&current_weather=true&timezone=Europe/Rome";
    
    const weatherResponse = await fetch(weatherUrl);
    if (!weatherResponse.ok) throw new Error("Errore nel recupero dati meteo");
    const meteo = await weatherResponse.json();
    
    if(!meteo.daily) throw new Error("Nessun dato meteo disponibile");

    // QualitÃ  aria (ora sempre disponibile)
    let aqiData = null;
    try {
      const aqiResponse = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=us_aqi&timezone=Europe/Rome`);
      if (aqiResponse.ok) {
        aqiData = await aqiResponse.json();
      }
    } catch (error) {
      console.warn("Errore nel caricamento dati AQI:", error);
    }

    // Costruzione HTML
    let html = `<h2>${display_name.split(',')[0]}<span class="fav-star" id="favStar">â˜†</span></h2>`;
    
    // AQI (sempre disponibile)
    if (aqiData && aqiData.current && aqiData.current.us_aqi !== undefined) {
      const aqi = Math.round(aqiData.current.us_aqi);
      const aqiDesc = getAQIDescription(aqi);
      html += `<div class="extra">ğŸŒ«ï¸ QualitÃ  Aria: ${aqi} (${aqiDesc})</div>`;
    }

    // Previsioni giornaliere
    meteo.daily.time.forEach((d, i) => {
      const date = new Date(d + 'T12:00:00');
      const dateStr = date.toLocaleDateString("it-IT", {weekday: "long", day: "2-digit", month: "2-digit"});
      const icon = weatherIcons[meteo.daily.weathercode[i]] || "â“";
      
      // UV Index (sempre disponibile)
      let uvInfo = "";
      if (meteo.daily.uv_index_max[i] !== undefined) {
        const uv = Math.round(meteo.daily.uv_index_max[i]);
        const uvDesc = getUVDescription(uv);
        uvInfo = ` | â˜€ï¸ UV: ${uv} (${uvDesc})`;
      }

      // Dettaglio orario - OGNI ORA (da 00 a 23)
      let hourlyHTML = "";
      for(let h = 0; h < 24; h++) {
        const timeStr = `${d}T${String(h).padStart(2, "0")}:00`;
        const idx = meteo.hourly.time.findIndex(t => t === timeStr);
        if(idx > -1) {
          const temp = Math.round(meteo.hourly.temperature_2m[idx]);
          const hourIcon = weatherIcons[meteo.hourly.weathercode[idx]] || "â“";
          const precip = meteo.hourly.precipitation[idx] || 0;
          
          hourlyHTML += `
            <div class="hour-block">
              <div>${String(h).padStart(2, "0")}:00</div>
              <div>${hourIcon}</div>
              <div>${temp}Â°</div>
              ${precip > 0 ? `<div style="font-size:0.6rem">${precip}mm</div>` : ''}
            </div>`;
        }
      }

      html += `
      <div class="day">
        <div class="date">${icon} ${dateStr}</div>
        <div>ğŸŒ¡ï¸ Max ${Math.round(meteo.daily.temperature_2m_max[i])}Â° / Min ${Math.round(meteo.daily.temperature_2m_min[i])}Â°</div>
        <div class="extra">ğŸŒ§ï¸ ${meteo.daily.precipitation_sum[i] || 0} mm | ğŸ’¨ ${Math.round(meteo.daily.windspeed_10m_max[i])} km/h${uvInfo}</div>
        <div class="hourly" style="display:flex;">${hourlyHTML}</div>
      </div>`;
    });

    resultDiv.innerHTML = html;

    // Toggle dettaglio orario
    document.querySelectorAll(".day").forEach(dayEl => {
      dayEl.addEventListener("click", () => {
        const hourly = dayEl.querySelector(".hourly");
        if (hourly) {
          hourly.style.display = hourly.style.display === "none" ? "flex" : "none";
        }
      });
    });

    // Gestione stelle preferiti
    const favStar = document.getElementById("favStar");
    let favs = JSON.parse(localStorage.getItem("favs") || "[]");
    if(favs.includes(city)) {
      favStar.textContent = "â­";
    }
    
    favStar.onclick = () => {
      let favs = JSON.parse(localStorage.getItem("favs") || "[]");
      if(favs.includes(city)) {
        favs = favs.filter(c => c !== city);
        favStar.textContent = "â˜†";
      } else {
        favs.push(city);
        favStar.textContent = "â­";
      }
      localStorage.setItem("favs", JSON.stringify(favs));
      loadFavorites();
    };

  } catch(err) {
    console.error("Errore:", err);
    resultDiv.innerHTML = `<div style="background:rgba(255,0,0,0.2);padding:1rem;border-radius:8px;color:#ffcccb;">
      <strong>âŒ Errore:</strong> ${err.message}<br>
      <small>Riprova tra qualche istante</small>
    </div>`;
  }
});
</script>

</body>
</html>